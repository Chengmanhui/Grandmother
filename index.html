<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å«²å«²é›»è©±ç°¿</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  
  <!-- React & ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone (for JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      touch-action: manipulation; /* Prevent double-tap zoom */
      background-color: #f8fafc; /* bg-slate-50 */
      color: #0f172a; /* text-slate-900 */
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    /* Prevent text selection to make it feel more like an app */
    .no-select {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="root" class="h-full w-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // --- ICONS (Inline SVGs to remove dependencies) ---
    const IconPhone = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
    );
    const IconMic = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
    );
    const IconSettings = ({ className, size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    );
    const IconTrash2 = ({ className, size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
    );
    const IconUserPlus = ({ className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
    );
    const IconX = ({ className, size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    );
    const IconRefreshCw = ({ className, size }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size || 24} height={size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
    );

    // --- CONSTANTS ---
    const INITIAL_CONTACTS = [
      { id: '1', name: 'ä¹–å­«', phoneNumber: '12345678' },
      { id: '2', name: 'é˜¿ä»”', phoneNumber: '87654321' },
      { id: '3', name: 'é˜¿å¥³', phoneNumber: '98765432' },
      { id: '4', name: 'é†«ç”Ÿ', phoneNumber: '999' },
    ];
    const SPEECH_LANG = 'yue-Hant-HK'; // Cantonese Hong Kong
    const TTS_LANG = 'zh-HK';
    const STORAGE_KEY = 'grandma_app_contacts';

    // --- UTILS ---
    const speakText = (text) => {
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = TTS_LANG;
      utterance.rate = 0.9;
      utterance.pitch = 1.0;
      const voices = window.speechSynthesis.getVoices();
      const cantoneseVoice = voices.find(v => v.lang.includes('HK') || v.lang.includes('yue'));
      if (cantoneseVoice) {
        utterance.voice = cantoneseVoice;
      }
      window.speechSynthesis.speak(utterance);
    };

    // --- HOOKS ---
    const useContacts = () => {
      const [contacts, setContacts] = useState([]);
      const [isLoaded, setIsLoaded] = useState(false);

      useEffect(() => {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          try {
            setContacts(JSON.parse(stored));
          } catch (e) {
            console.error("Failed to parse contacts", e);
            setContacts(INITIAL_CONTACTS);
          }
        } else {
          setContacts(INITIAL_CONTACTS);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(INITIAL_CONTACTS));
        }
        setIsLoaded(true);
      }, []);

      useEffect(() => {
        if (isLoaded) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(contacts));
        }
      }, [contacts, isLoaded]);

      const addContact = useCallback((name, phoneNumber) => {
        const newContact = {
          id: Date.now().toString(),
          name,
          phoneNumber,
        };
        setContacts(prev => [...prev, newContact]);
      }, []);

      const removeContact = useCallback((id) => {
        setContacts(prev => prev.filter(c => c.id !== id));
      }, []);

      const syncContacts = useCallback((incomingContacts) => {
        setContacts(prev => {
          const nextContacts = [...prev];
          let changes = false;

          incomingContacts.forEach(incoming => {
            const normalizedIncomingName = incoming.name.trim();
            const existingIndex = nextContacts.findIndex(c => 
              c.name.trim().toLowerCase() === normalizedIncomingName.toLowerCase()
            );

            if (existingIndex >= 0) {
              if (nextContacts[existingIndex].phoneNumber !== incoming.phoneNumber) {
                nextContacts[existingIndex] = { 
                  ...nextContacts[existingIndex], 
                  phoneNumber: incoming.phoneNumber 
                };
                changes = true;
              }
            } else {
              nextContacts.push({
                id: Date.now().toString() + Math.random().toString(36).slice(2, 9),
                name: normalizedIncomingName,
                phoneNumber: incoming.phoneNumber
              });
              changes = true;
            }
          });

          return changes ? nextContacts : prev;
        });
      }, []);

      const findContact = useCallback((spokenName) => {
        if (!spokenName) return undefined;
        const normalizedSpoken = spokenName.replace(/\s+/g, '').toLowerCase();
        return contacts.find(contact => {
          const normalizedContact = contact.name.replace(/\s+/g, '').toLowerCase();
          return normalizedSpoken.includes(normalizedContact) || normalizedContact.includes(normalizedSpoken);
        });
      }, [contacts]);

      return { contacts, addContact, removeContact, findContact, syncContacts };
    };

    // --- COMPONENTS ---

    // Voice Button Component
    const VoiceButton = ({ onSpeechResult, onSpeechError, onSpeechStart, onSpeechEnd }) => {
      const [isListening, setIsListening] = useState(false);
      const recognitionRef = useRef(null);
      const isHoldingRef = useRef(false);
      const hasPermissionRef = useRef(false);

      useEffect(() => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
          const recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = SPEECH_LANG;

          recognition.onstart = () => {
            setIsListening(true);
            onSpeechStart();
          };

          recognition.onend = () => {
            setIsListening(false);
            onSpeechEnd();
          };

          recognition.onresult = (event) => {
            if (event.results && event.results.length > 0) {
              const transcript = event.results[0][0].transcript;
              onSpeechResult(transcript);
            }
          };

          recognition.onerror = (event) => {
            console.error("Speech recognition error", event.error);
            if (event.error === 'not-allowed') {
              onSpeechError("è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™ (Please allow microphone)");
              hasPermissionRef.current = false;
            } else if (event.error === 'no-speech') {
              // Ignore
            } else if (event.error === 'aborted') {
              // Ignore
            } else {
              onSpeechError("è½å””æ¸…æ¥šï¼Œè«‹å†è©¦ä¸€æ¬¡");
            }
            setIsListening(false);
          };

          recognitionRef.current = recognition;
        } else {
          onSpeechError("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½");
        }
      }, [onSpeechResult, onSpeechError, onSpeechStart, onSpeechEnd]);

      const requestPermission = async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          return true;
        }
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          stream.getTracks().forEach(track => track.stop());
          hasPermissionRef.current = true;
          return true;
        } catch (err) {
          console.error("Permission denied", err);
          onSpeechError("ç„¡æ³•å­˜å–éº¥å…‹é¢¨");
          return false;
        }
      };

      const startListening = async () => {
        isHoldingRef.current = true;
        if (!hasPermissionRef.current) {
          const granted = await requestPermission();
          if (!granted) return;
        }
        if (recognitionRef.current && !isListening && isHoldingRef.current) {
          try {
            recognitionRef.current.start();
          } catch (e) {
            console.log("Recognition already started or failed", e);
          }
        }
      };

      const stopListening = () => {
        isHoldingRef.current = false;
        if (recognitionRef.current) {
          recognitionRef.current.stop();
        }
      };

      return (
        <div className="relative flex flex-col items-center justify-center">
          <button
            onMouseDown={startListening}
            onMouseUp={stopListening}
            onMouseLeave={stopListening}
            onTouchStart={(e) => { 
              if (e.cancelable) e.preventDefault(); 
              startListening(); 
            }} 
            onTouchEnd={(e) => { 
              if (e.cancelable) e.preventDefault(); 
              stopListening(); 
            }}
            className={`
              relative
              w-72 h-72 sm:w-80 sm:h-80
              rounded-full
              flex flex-col items-center justify-center
              transition-all duration-200
              shadow-xl
              select-none
              ${isListening 
                ? 'bg-red-500 scale-105 shadow-red-500/50' 
                : 'bg-green-500 hover:bg-green-600 active:scale-95 shadow-green-500/50'
              }
            `}
            aria-label="Hold to speak"
            style={{ WebkitTapHighlightColor: 'transparent' }}
          >
            {isListening ? (
              <React.Fragment>
                <div className="animate-pulse absolute w-full h-full rounded-full bg-red-400 opacity-50 scale-125 z-0"></div>
                <IconMic className="w-24 h-24 text-white z-10 mb-2" />
                <span className="text-white text-3xl font-bold z-10">æ”¾æ‰‹çµæŸ</span>
              </React.Fragment>
            ) : (
              <React.Fragment>
                <IconPhone className="w-24 h-24 text-white mb-4" />
                <span className="text-white text-4xl font-black tracking-widest">æŒ‰ä½è¬›</span>
              </React.Fragment>
            )}
          </button>

          <div className="mt-8 text-center space-y-2">
            <p className="text-3xl text-slate-700 font-bold">
              {isListening ? "æ­£åœ¨è†è½..." : "é•·æŒ‰å¤§æ£è¬›å€‹å"}
            </p>
          </div>
        </div>
      );
    };

    // Contact Manager Component
    const ContactManager = ({ contacts, onAdd, onRemove, onSync, isOpen, onClose }) => {
      const [newName, setNewName] = useState('');
      const [newNumber, setNewNumber] = useState('');
      const [isSupported, setIsSupported] = useState(false);
      const [isSyncing, setIsSyncing] = useState(false);

      useEffect(() => {
        setIsSupported('contacts' in navigator && 'ContactsManager' in window);
      }, []);

      if (!isOpen) return null;

      const handleSubmit = (e) => {
        e.preventDefault();
        if (newName.trim() && newNumber.trim()) {
          onAdd(newName.trim(), newNumber.trim());
          setNewName('');
          setNewNumber('');
        }
      };

      const handleSyncContacts = async () => {
        try {
          if (!navigator.contacts) return;
          setIsSyncing(true);
          const props = ['name', 'tel'];
          const opts = { multiple: true };
          const selectedContacts = await navigator.contacts.select(props, opts);
          
          const contactsToSync = selectedContacts
            .map(contact => {
              const name = contact.name?.[0];
              const tel = contact.tel?.[0];
              if (name && tel) {
                 return {
                   name: name,
                   phoneNumber: tel.replace(/[\s-()]/g, '')
                 };
              }
              return null;
            })
            .filter(c => c !== null);
          
          if (contactsToSync.length > 0) {
            onSync(contactsToSync);
            alert(`æˆåŠŸåŒæ­¥ ${contactsToSync.length} å€‹è¯çµ¡äºº (Synced ${contactsToSync.length} contacts)`);
          }
        } catch (ex) {
          console.error("Import failed or cancelled", ex);
        } finally {
          setIsSyncing(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] flex flex-col shadow-2xl">
            <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-green-50 rounded-t-2xl">
              <h2 className="text-3xl font-bold text-green-800">é›»è©±ç°¿ (Contacts)</h2>
              <button onClick={onClose} className="p-2 hover:bg-green-100 rounded-full text-green-800">
                <IconX size={32} />
              </button>
            </div>

            <div className="p-6 overflow-y-auto flex-1">
              {/* Sync Button */}
              {isSupported && (
                <button 
                  onClick={handleSyncContacts}
                  disabled={isSyncing}
                  className="w-full mb-6 bg-blue-100 text-blue-800 p-4 rounded-xl font-bold text-xl flex items-center justify-center gap-3 hover:bg-blue-200 transition-colors border-2 border-blue-200 disabled:opacity-50"
                >
                  <IconRefreshCw size={28} className={isSyncing ? "animate-spin" : ""} />
                  {isSyncing ? "åŒæ­¥ä¸­..." : "å¾æ‰‹æ©Ÿé€šè¨ŠéŒ„åŒæ­¥ (Sync)"}
                </button>
              )}

              <form onSubmit={handleSubmit} className="mb-8 bg-slate-50 p-4 rounded-xl border border-slate-200">
                <h3 className="text-xl font-bold mb-4 text-slate-700">æ‰‹å‹•æ–°å¢ (Add Manually)</h3>
                <div className="flex flex-col gap-4">
                  <input
                    type="text"
                    placeholder="åå­— (ä¾‹å¦‚: ä¹–å­«)"
                    value={newName}
                    onChange={e => setNewName(e.target.value)}
                    className="p-4 text-xl border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                  />
                  <input
                    type="tel"
                    placeholder="é›»è©±è™Ÿç¢¼"
                    value={newNumber}
                    onChange={e => setNewNumber(e.target.value)}
                    className="p-4 text-xl border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                  />
                  <button 
                    type="submit"
                    disabled={!newName || !newNumber}
                    className="bg-green-600 text-white p-4 rounded-lg font-bold text-xl flex items-center justify-center gap-2 disabled:opacity-50 hover:bg-green-700 transition-colors"
                  >
                    <IconUserPlus /> åŠ å…¥
                  </button>
                </div>
              </form>

              <div className="space-y-3">
                <h3 className="text-xl font-bold text-slate-700 mb-2">ç¾æœ‰è¯çµ¡äºº ({contacts.length})</h3>
                {contacts.length === 0 && (
                  <p className="text-gray-500 text-lg text-center py-8">æš«æ™‚æœªæœ‰è¯çµ¡äºº</p>
                )}
                {contacts.map(contact => (
                  <div key={contact.id} className="flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl shadow-sm">
                    <div>
                      <div className="text-2xl font-bold text-slate-800">{contact.name}</div>
                      <div className="text-lg text-slate-500">{contact.phoneNumber}</div>
                    </div>
                    <button
                      onClick={() => onRemove(contact.id)}
                      className="p-3 text-red-500 hover:bg-red-50 rounded-full transition-colors"
                      aria-label="Delete"
                    >
                      <IconTrash2 size={28} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const { contacts, addContact, removeContact, findContact, syncContacts } = useContacts();
      const [feedback, setFeedback] = useState('');
      const [isManagerOpen, setIsManagerOpen] = useState(false);
      const [lastTranscript, setLastTranscript] = useState('');

      useEffect(() => {
        setFeedback("æº–å‚™å¥½å•¦ (Ready)");
      }, []);

      const handleSpeechResult = (transcript) => {
        setLastTranscript(transcript);
        const contact = findContact(transcript);

        if (contact) {
          const msg = `æ‰“ç·Šä¿¾ ${contact.name}`;
          setFeedback(msg);
          speakText(msg);
          setTimeout(() => {
            window.location.href = `tel:${contact.phoneNumber}`;
          }, 1500);
        } else {
          const msg = `æµå””åˆ° "${transcript}"`;
          setFeedback(msg);
          speakText(`æµå””åˆ° ${transcript}ï¼Œè«‹å†è©¦ä¸€æ¬¡`);
        }
      };

      const handleSpeechError = (error) => {
        setFeedback(error);
        speakText("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡");
      };

      const handleSpeechStart = () => {
        setFeedback("è†è½ä¸­...");
      };

      const handleSpeechEnd = () => {
        setFeedback(prev => {
          if (prev === "è†è½ä¸­...") {
            return "æº–å‚™å¥½å•¦ (Ready)";
          }
          return prev;
        });
      };

      return (
        <div className="min-h-screen bg-slate-50 flex flex-col relative">
          <header className="p-4 flex justify-between items-center absolute top-0 w-full z-10">
            <h1 className="text-xl font-bold text-slate-400">ğŸ‘µ å«²å«²é›»è©±ç°¿</h1>
            <button 
              onClick={() => setIsManagerOpen(true)}
              className="bg-white p-3 rounded-full shadow-md text-slate-600 hover:text-green-600 transition-colors border border-slate-200"
              aria-label="Manage Contacts"
            >
              <IconSettings size={28} />
            </button>
          </header>

          <main className="flex-1 flex flex-col items-center justify-center p-6 gap-8">
            <div className="h-24 flex items-end justify-center mb-4">
              <p className="text-2xl md:text-3xl font-bold text-green-700 text-center px-4 py-2 bg-green-50 rounded-xl border border-green-100 shadow-sm min-w-[200px]">
                {feedback}
              </p>
            </div>

            <VoiceButton 
              onSpeechResult={handleSpeechResult}
              onSpeechError={handleSpeechError}
              onSpeechStart={handleSpeechStart}
              onSpeechEnd={handleSpeechEnd}
            />

            <div className="h-12 text-center">
              {lastTranscript && (
                <p className="text-slate-400 text-lg">
                  è½åˆ°: "{lastTranscript}"
                </p>
              )}
            </div>
          </main>

          <footer className="p-6 text-center text-slate-400 text-sm">
            <p>é•·æŒ‰ç¶ è‰²æŒ‰éˆ•ï¼Œè¬›å‡ºåå­—å³å¯æ’¥æ‰“</p>
            <p>Press and hold the green button to call</p>
          </footer>

          <ContactManager 
            isOpen={isManagerOpen}
            onClose={() => setIsManagerOpen(false)}
            contacts={contacts}
            onAdd={addContact}
            onRemove={removeContact}
            onSync={syncContacts}
          />
        </div>
      );
    };

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
